{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["import { NextResponse, type NextRequest } from \"next/server\";\r\n\r\n// Protected routes: add here the paths that require authentication\r\nconst PROTECTED = [\r\n  \"/\",\r\n  \"/inicio\",\r\n  \"/inventario\",\r\n  \"/inventario/\",\r\n  \"/categorias\",\r\n  \"/presupuesto\",\r\n  \"/ajustes\",\r\n];\r\n\r\nfunction isProtected(pathname: string): boolean {\r\n  // Exact matches or startsWith for subpaths\r\n  return PROTECTED.some((base) =>\r\n    pathname === base || pathname.startsWith(`${base}/`)\r\n  );\r\n}\r\n\r\nfunction getBackendBase(): string {\r\n  const env = process.env.NEXT_PUBLIC_API_URL || process.env.NEXT_PUBLIC_BACKEND_URL;\r\n  if (env) return env.replace(/\\/+$/, \"\");\r\n  return \"http://localhost:8000\";\r\n}\r\n\r\nexport async function middleware(request: NextRequest) {\r\n  const { pathname } = request.nextUrl;\r\n\r\n  // Skip login, recovery, test pages, assets and Next internals\r\n  if (\r\n    pathname.startsWith(\"/_next\") ||\r\n    pathname.startsWith(\"/api/\") ||\r\n    pathname.startsWith(\"/favicon\") ||\r\n    pathname.startsWith(\"/logo\") ||\r\n    pathname.startsWith(\"/login\") ||\r\n    pathname.startsWith(\"/recuperacion\") ||\r\n    pathname.startsWith(\"/idioma\")  // Allow language page\r\n  ) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  if (!isProtected(pathname)) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // If we already have a Django session cookie, allow (fast path in dev)\r\n  const hasSession = request.cookies.get(\"sessionid\");\r\n  if (hasSession) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // Verify session against backend /api/me/ by forwarding cookies\r\n  const backend = getBackendBase();\r\n  const cookieHeader = request.headers.get(\"cookie\") || \"\";\r\n\r\n  try {\r\n    const res = await fetch(`${backend}/api/me/`, {\r\n      method: \"GET\",\r\n      headers: { cookie: cookieHeader },\r\n      // Edge runtime ignores credentials, forward cookies manually as above\r\n      cache: \"no-store\",\r\n    });\r\n\r\n    if (res.ok) {\r\n      return NextResponse.next();\r\n    }\r\n  } catch {\r\n    // Network error -> treat as unauthenticated\r\n  }\r\n\r\n  const loginUrl = new URL(\"/login\", request.url);\r\n  loginUrl.searchParams.set(\"next\", pathname);\r\n  return NextResponse.redirect(loginUrl);\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    \"/((?!_next|api|favicon|logo).*)\",\r\n  ],\r\n};\r\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;;AAEA,mEAAmE;AACnE,MAAM,YAAY;IAChB;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAED,SAAS,YAAY,QAAgB;IACnC,2CAA2C;IAC3C,OAAO,UAAU,IAAI,CAAC,CAAC,OACrB,aAAa,QAAQ,SAAS,UAAU,CAAC,GAAG,KAAK,CAAC,CAAC;AAEvD;AAEA,SAAS;IACP,MAAM,MAAM,6DAAmC,QAAQ,GAAG,CAAC,uBAAuB;IAClF,wCAAS,OAAO,IAAI,OAAO,CAAC,QAAQ;;;AAEtC;AAEO,eAAe,WAAW,OAAoB;IACnD,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IAEpC,8DAA8D;IAC9D,IACE,SAAS,UAAU,CAAC,aACpB,SAAS,UAAU,CAAC,YACpB,SAAS,UAAU,CAAC,eACpB,SAAS,UAAU,CAAC,YACpB,SAAS,UAAU,CAAC,aACpB,SAAS,UAAU,CAAC,oBACpB,SAAS,UAAU,CAAC,WAAY,sBAAsB;MACtD;QACA,OAAO,gMAAY,CAAC,IAAI;IAC1B;IAEA,IAAI,CAAC,YAAY,WAAW;QAC1B,OAAO,gMAAY,CAAC,IAAI;IAC1B;IAEA,uEAAuE;IACvE,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI,YAAY;QACd,OAAO,gMAAY,CAAC,IAAI;IAC1B;IAEA,gEAAgE;IAChE,MAAM,UAAU;IAChB,MAAM,eAAe,QAAQ,OAAO,CAAC,GAAG,CAAC,aAAa;IAEtD,IAAI;QACF,MAAM,MAAM,MAAM,MAAM,GAAG,QAAQ,QAAQ,CAAC,EAAE;YAC5C,QAAQ;YACR,SAAS;gBAAE,QAAQ;YAAa;YAChC,sEAAsE;YACtE,OAAO;QACT;QAEA,IAAI,IAAI,EAAE,EAAE;YACV,OAAO,gMAAY,CAAC,IAAI;QAC1B;IACF,EAAE,OAAM;IACN,4CAA4C;IAC9C;IAEA,MAAM,WAAW,IAAI,IAAI,UAAU,QAAQ,GAAG;IAC9C,SAAS,YAAY,CAAC,GAAG,CAAC,QAAQ;IAClC,OAAO,gMAAY,CAAC,QAAQ,CAAC;AAC/B;AAEO,MAAM,SAAS;IACpB,SAAS;QACP;KACD;AACH"}}]
}